<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIEI ¬∑ ¬øQu√© es un mapa?</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --ink:#e8eeff; --muted:#a9b6e6;
      --ok:#2ee59d; --bad:#ff5c7a; --accent:#7aa7ff;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% 10%, #1a2a6a 0%, var(--bg) 55%) fixed;
      color:var(--ink);
      min-height:100vh;
    }
    .wrap{
      max-width: 1040px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom: 14px;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    h1{font-size:20px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .topBtns{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
      cursor:pointer; border:0; border-radius: 14px; padding: 12px 14px;
      background: rgba(255,255,255,.08); color: var(--ink);
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .08s ease, background .12s ease, opacity .12s ease;
      font-weight: 650;
    }
    button:hover{background: rgba(255,255,255,.12)}
    button:active{transform: translateY(1px)}
    button.primary{background: linear-gradient(180deg, rgba(122,167,255,.95), rgba(122,167,255,.65)); color:#081127}
    button.good{background: linear-gradient(180deg, rgba(46,229,157,.95), rgba(46,229,157,.65)); color:#061318}
    button.bad{background: linear-gradient(180deg, rgba(255,92,122,.95), rgba(255,92,122,.65)); color:#1b0710}
    button.small{padding:10px 12px; border-radius: 12px; font-weight:650; font-size:14px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .row{display:flex; gap:14px; flex-wrap:wrap}
    .grow{flex:1 1 380px}
    .q{
      font-size:18px; font-weight:750; margin:0 0 10px;
    }
    .hint{color:var(--muted); margin:0 0 12px; font-size:14px}
    .choices{
      display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .choice{
      border-radius: 18px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      display:flex; flex-direction:column; gap:10px;
      min-height: 220px;
      position:relative;
      overflow:hidden;
    }
    .choice .label{
      font-size:16px; font-weight:800;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .badge{
      font-size:12px; color:#081127;
      background: rgba(122,167,255,.95);
      padding: 6px 10px; border-radius: 999px; font-weight:800;
    }
    .choice .art{
      flex: 1;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .choice .tap{
      width:100%;
      border-radius: 14px;
      padding: 12px 14px;
      background: rgba(255,255,255,.10);
      font-size:16px;
      font-weight:850;
    }
    .feedback{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size: 15px;
      min-height: 50px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .feedback .msg{flex:1}
    .pill{
      font-weight:900;
      font-size:12px;
      padding: 7px 10px;
      border-radius: 999px;
      color:#061318;
      background: rgba(255,255,255,.12);
    }
    .pill.ok{background: rgba(46,229,157,.95)}
    .pill.bad{background: rgba(255,92,122,.95); color:#1b0710}
    .nav{
      margin-top: 14px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .progress{
      display:flex; gap:8px; align-items:center;
      color:var(--muted); font-size:13px;
    }
    .dots{display:flex; gap:6px}
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.18);
    }
    .dot.on{background: rgba(122,167,255,.85)}
    /* Drag build stage */
    .build{
      display:grid; grid-template-columns: 1fr 320px; gap:14px;
      align-items:start;
    }
    @media (max-width: 860px){
      .choices{grid-template-columns: 1fr}
      .build{grid-template-columns: 1fr}
    }
    .mapArea{
      background: rgba(0,0,0,.20);
      border: 1px dashed rgba(255,255,255,.22);
      border-radius: 18px;
      padding: 12px;
      min-height: 360px;
      position: relative;
      overflow:hidden;
    }
    .mapArea .gridTitle{
      display:flex; justify-content:space-between; align-items:center;
      color:var(--muted); font-size:13px; margin-bottom:10px;
    }
    .mapCanvas{
      position:relative;
      height: 300px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .anchor{
      position:absolute;
      width: 92px; height: 92px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,.18);
      background: rgba(122,167,255,.08);
      display:flex; align-items:center; justify-content:center;
      color: var(--muted);
      font-weight:900;
      user-select:none;
    }
    .pieceTray{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
    }
    .pieceTray h3{margin:0 0 8px; font-size:15px}
    .pieces{
      display:flex; flex-direction:column; gap:10px;
    }
    .piece{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
      user-select:none;
      touch-action:none;
    }
    .piece .icon{
      width: 42px; height: 42px; border-radius: 14px;
      background: rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      border: 1px solid rgba(255,255,255,.10);
      font-size: 20px;
    }
    .piece.placed{opacity:.55}
    .miniNote{color:var(--muted); font-size:13px; margin-top:10px; line-height:1.35}
    .finalGrid{
      display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .miniCard{
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .miniCard strong{font-size:16px}
    .miniCard .tag{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      color: var(--muted);
    }
    .miniCard.correct{border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.10)}
    .miniCard.correct .tag{background: rgba(46,229,157,.92); color:#061318}
    .miniCard.wrong{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10)}
    .miniCard.wrong .tag{background: rgba(255,92,122,.92); color:#1b0710}
    .toast{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.75);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--ink);
      box-shadow: var(--shadow);
      max-width: min(680px, calc(100% - 20px));
      display:none;
      gap:10px;
      align-items:center;
      z-index: 50;
    }
    .toast.show{display:flex}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      margin-left:6px;
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>üó∫Ô∏è SIEI ¬∑ ¬øQu√© es un mapa?</h1>
        <div class="sub">Actividad interactiva (clic + audio + arrastrar). Objetivo: ‚Äúdibujo desde arriba para orientarse‚Äù.</div>
      </div>
      <div class="topBtns">
        <button class="small" id="btnSpeak">üîä Voz: ON</button>
        <button class="small" id="btnRepeat">‚Üª Repetir audio</button>
        <button class="small" id="btnReset">‚ü≤ Reiniciar</button>
      </div>
    </header>

    <main class="card" id="app"></main>

    <div class="toast" id="toast">
      <div>Tip: si no se oye, activa el sonido del PC y prueba otro navegador.</div>
      <div class="kbd">Chrome / Edge</div>
    </div>
  </div>

<script>
(() => {
  // ----------------------------
  // Simple TTS (SpeechSynthesis)
  // ----------------------------
  let speakEnabled = true;
  let lastSpoken = "";
  const toast = document.getElementById("toast");

  function showToast(){
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 3500);
  }

  function speak(text){
    lastSpoken = text;
    if(!speakEnabled) return;
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-ES";
      u.rate = 0.95;
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
    }catch(e){
      // If blocked, show quick hint
      showToast();
    }
  }

  function beep(ok=true){
    // small WebAudio beep (no files)
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = ok ? 880 : 220;
      g.gain.value = 0.07;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.09);
      setTimeout(()=>ctx.close(), 120);
    }catch(e){}
  }

  // ----------------------------
  // App state
  // ----------------------------
  const app = document.getElementById("app");
  const btnSpeak = document.getElementById("btnSpeak");
  const btnRepeat = document.getElementById("btnRepeat");
  const btnReset = document.getElementById("btnReset");

  btnSpeak.addEventListener("click", () => {
    speakEnabled = !speakEnabled;
    btnSpeak.textContent = speakEnabled ? "üîä Voz: ON" : "üîá Voz: OFF";
    beep(true);
  });
  btnRepeat.addEventListener("click", () => {
    if(lastSpoken) speak(lastSpoken);
    else speak("Todav√≠a no hay audio.");
  });

  const SCREENS = ["s1", "s2", "s3", "s4", "s5", "done"];
  let screenIndex = 0;

  function setScreen(idx){
    screenIndex = Math.max(0, Math.min(idx, SCREENS.length-1));
    render();
  }

  btnReset.addEventListener("click", () => {
    // Reset everything
    screenIndex = 0;
    state.s1Answered = false;
    state.s2Answered = false;
    state.buildPlaced = { mesa:false, puerta:false, pizarra:false };
    state.s5Picked = { google:false, metro:false, foto:false, globo:false };
    state.s5Locked = false;
    render();
    speak("Empezamos de nuevo.");
    beep(true);
  });

  const state = {
    s1Answered: false,
    s2Answered: false,
    buildPlaced: { mesa:false, puerta:false, pizarra:false },
    s5Picked: { google:false, metro:false, foto:false, globo:false },
    s5Locked: false
  };

  // ----------------------------
  // Helpers
  // ----------------------------
  function dots(){
    const total = 5;
    const on = Math.min(total-1, screenIndex);
    const d = [];
    for(let i=0;i<total;i++){
      d.push(`<span class="dot ${i===on ? 'on' : ''}"></span>`);
    }
    return `<div class="progress">
      <span>Paso ${Math.min(5, screenIndex+1)} / 5</span>
      <span class="dots">${d.join("")}</span>
    </div>`;
  }

  function nav(canBack=true, canNext=true, nextText="Siguiente ‚ñ∂"){
    return `
      <div class="nav">
        <div>${dots()}</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
          <button class="small" ${canBack ? "" : "disabled style='opacity:.45; cursor:not-allowed'"} id="btnBack">‚óÄ Atr√°s</button>
          <button class="small primary" ${canNext ? "" : "disabled style='opacity:.45; cursor:not-allowed'"} id="btnNext">${nextText}</button>
        </div>
      </div>
    `;
  }

  function mountNavHandlers(canBack, canNext){
    const b = document.getElementById("btnBack");
    const n = document.getElementById("btnNext");
    if(b) b.addEventListener("click", () => {
      if(!canBack) return;
      beep(true);
      setScreen(screenIndex-1);
    });
    if(n) n.addEventListener("click", () => {
      if(!canNext) return;
      beep(true);
      setScreen(screenIndex+1);
    });
  }

  // ----------------------------
  // Screen 1: Choose what helps "see all"
  // ----------------------------
  function renderS1(){
    const html = `
      <div class="row">
        <div class="grow">
          <p class="q">1) ¬øD√≥nde se ve TODO de golpe?</p>
          <p class="hint">Elige una opci√≥n. Luego te digo por qu√©.</p>

          <div class="choices">
            <div class="choice" id="c1_photo">
              <div class="label">
                <span>üì∑ Foto del aula (dentro)</span>
                <span class="badge">REAL</span>
              </div>
              <div class="art" aria-hidden="true">
                ${svgPhotoRoom()}
              </div>
              <button class="tap" data-pick="photo">Tocar</button>
            </div>

            <div class="choice" id="c1_plan">
              <div class="label">
                <span>üß© Dibujo del aula (desde arriba)</span>
                <span class="badge">DESDE ARRIBA</span>
              </div>
              <div class="art" aria-hidden="true">
                ${svgPlanRoom()}
              </div>
              <button class="tap" data-pick="plan">Tocar</button>
            </div>
          </div>

          <div class="feedback" id="fb1">
            <div class="msg">Toca una opci√≥n.</div>
            <div class="pill">‚Ä¶</div>
          </div>

          ${nav(false, state.s1Answered)}
        </div>
      </div>
    `;

    app.innerHTML = html;

    const fb = document.getElementById("fb1");
    function setFB(ok, msg){
      fb.querySelector(".msg").textContent = msg;
      const pill = fb.querySelector(".pill");
      pill.textContent = ok ? "BIEN" : "CASI";
      pill.className = "pill " + (ok ? "ok" : "bad");
    }

    app.querySelectorAll("[data-pick]").forEach(btn => {
      btn.addEventListener("click", () => {
        const pick = btn.getAttribute("data-pick");
        state.s1Answered = true;
        if(pick === "photo"){
          beep(false);
          setFB(false, "Aqu√≠ est√°s dentro. No ves todo el aula a la vez.");
          speak("Aqu√≠ est√°s dentro. No ves todo el aula a la vez.");
        }else{
          beep(true);
          setFB(true, "Desde arriba se ve todo. Esto ayuda a orientarse.");
          speak("Desde arriba se ve todo. Esto ayuda a orientarse.");
        }
        // enable next
        app.querySelector("#btnNext").disabled = false;
        app.querySelector("#btnNext").style.opacity = "1";
        app.querySelector("#btnNext").style.cursor = "pointer";
      });
    });

    mountNavHandlers(false, state.s1Answered);

    // Intro audio (only first time entering screen)
    speak("¬øD√≥nde se ve todo de golpe? Toca una opci√≥n.");
  }

  // ----------------------------
  // Screen 2: Use it to reach bathroom
  // ----------------------------
  function renderS2(){
    const html = `
      <div class="row">
        <div class="grow">
          <p class="q">2) El ni√±o quiere ir al ba√±o üöª</p>
          <p class="hint">¬øQu√© le ayuda a no perderse?</p>

          <div class="choices">
            <div class="choice">
              <div class="label">
                <span>üì∑ Foto del pasillo</span>
                <span class="badge">REAL</span>
              </div>
              <div class="art" aria-hidden="true">
                ${svgHallPhoto()}
              </div>
              <button class="tap" data-pick="photo">Elegir</button>
            </div>

            <div class="choice">
              <div class="label">
                <span>üó∫Ô∏è Plano del pasillo (desde arriba)</span>
                <span class="badge">MAPA</span>
              </div>
              <div class="art" aria-hidden="true">
                ${svgHallPlan()}
              </div>
              <button class="tap" data-pick="map">Elegir</button>
            </div>
          </div>

          <div class="feedback" id="fb2">
            <div class="msg">Elige una opci√≥n.</div>
            <div class="pill">‚Ä¶</div>
          </div>

          ${nav(true, state.s2Answered)}
        </div>
      </div>
    `;
    app.innerHTML = html;

    const fb = document.getElementById("fb2");
    function setFB(ok, msg){
      fb.querySelector(".msg").textContent = msg;
      const pill = fb.querySelector(".pill");
      pill.textContent = ok ? "¬°MAPA!" : "CASI";
      pill.className = "pill " + (ok ? "ok" : "bad");
    }

    app.querySelectorAll("[data-pick]").forEach(btn => {
      btn.addEventListener("click", () => {
        const pick = btn.getAttribute("data-pick");
        state.s2Answered = true;
        if(pick === "map"){
          beep(true);
          setFB(true, "¬°Correcto! Un MAPA ayuda a llegar sin perderse.");
          speak("¬°Correcto! Un mapa ayuda a llegar sin perderse.");
        }else{
          beep(false);
          setFB(false, "La foto es real, pero no te dice por d√≥nde ir.");
          speak("La foto es real, pero no te dice por d√≥nde ir.");
        }
        app.querySelector("#btnNext").disabled = false;
        app.querySelector("#btnNext").style.opacity = "1";
        app.querySelector("#btnNext").style.cursor = "pointer";
      });
    });

    mountNavHandlers(true, state.s2Answered);

    speak("El ni√±o quiere ir al ba√±o. ¬øQu√© le ayuda a no perderse?");
  }

  // ----------------------------
  // Screen 3: Key idea
  // ----------------------------
  function renderS3(){
    const html = `
      <div class="row">
        <div class="grow">
          <p class="q">3) Idea clave</p>
          <p class="hint">Los mapas se miran <strong>desde arriba</strong>, como un p√°jaro.</p>

          <div class="card" style="padding:14px; margin-top:10px;">
            ${svgSquashAnim()}
            <div class="feedback" style="margin-top:12px;">
              <div class="msg"><strong>Mapa = dibujo desde arriba</strong> para orientarse.</div>
              <div class="pill ok">CLAVE</div>
            </div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="good" id="btnSpeakKey">üîä Escuchar</button>
              <button class="small" id="btnAgain">‚Üª Otra vez</button>
            </div>
          </div>

          ${nav(true, true)}
        </div>
      </div>
    `;
    app.innerHTML = html;

    document.getElementById("btnSpeakKey").addEventListener("click", () => {
      beep(true);
      speak("Los mapas se miran desde arriba, como un p√°jaro. Un mapa es un dibujo desde arriba para orientarse.");
    });
    document.getElementById("btnAgain").addEventListener("click", () => {
      beep(true);
      speak("Mapa: dibujo desde arriba para orientarse.");
    });

    mountNavHandlers(true, true);

    speak("Los mapas se miran desde arriba, como un p√°jaro.");
  }

  // ----------------------------
  // Screen 4: Build your map (drag pieces)
  // ----------------------------
  function renderS4(){
    const placed = state.buildPlaced;
    const allPlaced = placed.mesa && placed.puerta && placed.pizarra;

    const html = `
      <div class="row">
        <div class="grow">
          <p class="q">4) Construye un mapa del aula</p>
          <p class="hint">Arrastra y suelta: <strong>Mesa</strong>, <strong>Puerta</strong> y <strong>Pizarra</strong>.</p>

          <div class="build">
            <div class="mapArea">
              <div class="gridTitle">
                <span>üìå Vista desde arriba (mapa)</span>
                <span>${allPlaced ? "‚úÖ Completado" : "Coloca las 3 piezas"}</span>
              </div>
              <div class="mapCanvas" id="mapCanvas">
                <div class="anchor" data-slot="mesa" style="left: 10%; top: 58%;">MESA</div>
                <div class="anchor" data-slot="puerta" style="left: 72%; top: 12%;">PUERTA</div>
                <div class="anchor" data-slot="pizarra" style="left: 12%; top: 10%;">PIZARRA</div>
              </div>
              <div class="miniNote">
                Si cuesta: empieza con una sola pieza, celebra el acierto y luego otra.
              </div>
            </div>

            <div class="pieceTray">
              <h3>üß© Piezas</h3>
              <div class="pieces" id="pieces">
                ${pieceHTML("mesa","ü™ë","MESA", placed.mesa)}
                ${pieceHTML("puerta","üö™","PUERTA", placed.puerta)}
                ${pieceHTML("pizarra","üü©","PIZARRA", placed.pizarra)}
              </div>
              <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="small" id="btnHelp">üîä Ayuda</button>
                <button class="small" id="btnResetBuild">‚ü≤ Reset piezas</button>
              </div>
            </div>
          </div>

          <div class="feedback" id="fb4" style="margin-top:14px;">
            <div class="msg">${allPlaced ? "¬°Has creado un mapa!" : "Coloca las 3 piezas en su sitio."}</div>
            <div class="pill ${allPlaced ? "ok" : ""}">${allPlaced ? "MAPA" : "‚Ä¶"}</div>
          </div>

          ${nav(true, allPlaced)}
        </div>
      </div>
    `;

    app.innerHTML = html;

    const fb = document.getElementById("fb4");
    function setFB(ok, msg){
      fb.querySelector(".msg").textContent = msg;
      const pill = fb.querySelector(".pill");
      pill.textContent = ok ? "¬°BIEN!" : "SIGUE";
      pill.className = "pill " + (ok ? "ok" : "");
    }

    document.getElementById("btnHelp").addEventListener("click", () => {
      beep(true);
      speak("Arrastra una pieza y su√©ltala encima de la palabra igual. Por ejemplo: arrastra MESA y su√©ltala en MESA.");
    });

    document.getElementById("btnResetBuild").addEventListener("click", () => {
      beep(true);
      state.buildPlaced = { mesa:false, puerta:false, pizarra:false };
      render();
      speak("Piezas reiniciadas.");
    });

    // Drag & drop using pointer events
    const canvas = document.getElementById("mapCanvas");
    const anchors = Array.from(canvas.querySelectorAll(".anchor"));
    const pieces = Array.from(document.querySelectorAll(".piece"));

    const rectFor = (el) => el.getBoundingClientRect();
    function hitTest(pieceEl){
      const pr = rectFor(pieceEl);
      const pcx = pr.left + pr.width/2;
      const pcy = pr.top + pr.height/2;
      for(const a of anchors){
        const ar = rectFor(a);
        if(pcx >= ar.left && pcx <= ar.right && pcy >= ar.top && pcy <= ar.bottom){
          return a.getAttribute("data-slot");
        }
      }
      return null;
    }

    pieces.forEach(p => {
      const id = p.getAttribute("data-piece");
      if(state.buildPlaced[id]) return;

      let startX=0, startY=0, origLeft=0, origTop=0;
      let dragging=false;

      const onDown = (e) => {
        if(state.buildPlaced[id]) return;
        dragging = true;
        p.setPointerCapture(e.pointerId);
        const r = p.getBoundingClientRect();
        startX = e.clientX;
        startY = e.clientY;
        origLeft = r.left;
        origTop = r.top;

        // move to fixed overlay positioning
        p.style.position = "fixed";
        p.style.left = origLeft + "px";
        p.style.top = origTop + "px";
        p.style.width = r.width + "px";
        p.style.zIndex = 30;
        p.style.transform = "scale(1.02)";
        p.style.opacity = "1";
        beep(true);
      };

      const onMove = (e) => {
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        p.style.left = (origLeft + dx) + "px";
        p.style.top = (origTop + dy) + "px";
      };

      const onUp = (e) => {
        if(!dragging) return;
        dragging = false;
        p.releasePointerCapture(e.pointerId);

        const target = hitTest(p);
        if(target && target === id){
          state.buildPlaced[id] = true;
          beep(true);
          speak("¬°Bien! " + id.toUpperCase() + " en su sitio.");
          setFB(true, "¬°Bien! Has colocado " + id.toUpperCase() + ".");
          render(); // rerender to lock placed
        }else{
          beep(false);
          speak("Casi. Su√©ltalo encima de la palabra igual.");
          setFB(false, "Casi. Su√©ltalo encima de la palabra igual.");
          // snap back by rerendering screen
          render();
        }
      };

      p.addEventListener("pointerdown", onDown);
      p.addEventListener("pointermove", onMove);
      p.addEventListener("pointerup", onUp);
      p.addEventListener("pointercancel", onUp);
    });

    mountNavHandlers(true, allPlaced);
    speak("Arrastra y suelta: mesa, puerta y pizarra.");
  }

  function pieceHTML(id, icon, label, placed){
    return `
      <div class="piece ${placed ? "placed" : ""}" data-piece="${id}" role="button" aria-label="Pieza ${label}">
        <div class="icon">${icon}</div>
        <div style="flex:1; font-size:16px;">${label}</div>
        <div style="font-size:12px; color: var(--muted); font-weight:900;">
          ${placed ? "‚úÖ" : "ARRASTRA"}
        </div>
      </div>
    `;
  }

  // ----------------------------
  // Screen 5: Pick maps
  // ----------------------------
  function renderS5(){
    const picked = state.s5Picked;
    const correct = {
      google: true,
      metro: true,
      foto: false,
      globo: true
    };

    const allAnswered = picked.google || picked.metro || picked.foto || picked.globo;
    const allCorrectChosen =
      picked.google === true &&
      picked.metro === true &&
      picked.globo === true &&
      picked.foto === false;

    const html = `
      <div class="row">
        <div class="grow">
          <p class="q">5) Toca los MAPAS</p>
          <p class="hint">Elige los que ayudan a orientarse.</p>

          <div class="finalGrid">
            ${miniPick("google","üìç Google Maps", picked.google)}
            ${miniPick("metro","üöá Plano del metro", picked.metro)}
            ${miniPick("foto","üì∑ Foto de una ciudad", picked.foto)}
            ${miniPick("globo","üåç Globo terr√°queo", picked.globo)}
          </div>

          <div class="feedback" id="fb5">
            <div class="msg">${state.s5Locked ? (allCorrectChosen ? "¬°Perfecto! Ya lo tienes." : "Revisa: un mapa te ayuda a orientarte.") : "Toca y luego comprueba."}</div>
            <div class="pill ${allCorrectChosen ? "ok" : ""}">${state.s5Locked ? (allCorrectChosen ? "‚úÖ" : "‚Ä¶") : "‚Ä¶"} </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="good" id="btnCheck">‚úî Comprobar</button>
            <button class="small" id="btnClear">Borrar</button>
          </div>

          ${nav(true, state.s5Locked && allCorrectChosen, "Terminar ‚úÖ")}
        </div>
      </div>
    `;

    app.innerHTML = html;

    // click pick
    document.querySelectorAll("[data-pickmap]").forEach(el => {
      el.addEventListener("click", () => {
        if(state.s5Locked) return;
        const key = el.getAttribute("data-pickmap");
        picked[key] = !picked[key];
        beep(true);
        renderS5(); // local rerender
      });
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      if(state.s5Locked) return;
      beep(true);
      state.s5Picked = { google:false, metro:false, foto:false, globo:false };
      render();
      speak("Borrado.");
    });

    document.getElementById("btnCheck").addEventListener("click", () => {
      state.s5Locked = true;

      const mistakes = [];
      for(const k of Object.keys(correct)){
        if(picked[k] !== correct[k]){
          mistakes.push(k);
        }
      }

      if(mistakes.length === 0){
        beep(true);
        speak("¬°Perfecto! Has encontrado los mapas.");
      }else{
        beep(false);
        speak("Casi. Recuerda: un mapa ayuda a orientarse.");
      }
      renderS5(); // show locked feedback & enable next if perfect
    });

    mountNavHandlers(true, state.s5Locked && allCorrectChosen);

    if(!state.s5Locked) speak("Toca los mapas: los que ayudan a orientarse.");
  }

  function miniPick(key, title, on){
    return `
      <div class="miniCard ${on ? "correct" : ""}" data-pickmap="${key}" style="cursor:pointer;">
        <strong>${title}</strong>
        <span class="tag">${on ? "ELEGIDO" : "TOCA"}</span>
      </div>
    `;
  }

  // ----------------------------
  // Done
  // ----------------------------
  function renderDone(){
    const html = `
      <div class="row">
        <div class="grow">
          <p class="q">‚úÖ ¬°Actividad terminada!</p>
          <p class="hint">Frase final (SIEI):</p>

          <div class="feedback" style="margin-top:10px;">
            <div class="msg" style="font-size:18px; font-weight:900;">
              MAPA = dibujo desde arriba para orientarse
            </div>
            <div class="pill ok">CLARO</div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="good" id="btnSayFinal">üîä Escuchar</button>
            <button class="small primary" id="btnStartOver">‚ü≤ Empezar otra vez</button>
          </div>
        </div>
      </div>
    `;
    app.innerHTML = html;

    document.getElementById("btnSayFinal").addEventListener("click", () => {
      beep(true);
      speak("Mapa: dibujo desde arriba para orientarse.");
    });
    document.getElementById("btnStartOver").addEventListener("click", () => {
      beep(true);
      btnReset.click();
    });

    speak("Muy bien. Mapa: dibujo desde arriba para orientarse.");
  }

  // ----------------------------
  // Render router
  // ----------------------------
  function render(){
    const id = SCREENS[screenIndex];
    if(id === "s1") return renderS1();
    if(id === "s2") return renderS2();
    if(id === "s3") return renderS3();
    if(id === "s4") return renderS4();
    if(id === "s5") return renderS5();
    return renderDone();
  }

  // ----------------------------
  // Inline SVG ‚Äúimages‚Äù
  // ----------------------------
  function svgPhotoRoom(){
    return `
      <svg viewBox="0 0 420 220" width="100%" height="100%" role="img" aria-label="Foto estilo aula">
        <defs>
          <linearGradient id="g1" x1="0" x2="1">
            <stop offset="0" stop-color="rgba(255,255,255,.10)"/>
            <stop offset="1" stop-color="rgba(255,255,255,.02)"/>
          </linearGradient>
        </defs>
        <rect x="10" y="10" width="400" height="200" rx="18" fill="url(#g1)" stroke="rgba(255,255,255,.18)"/>
        <rect x="40" y="46" width="140" height="78" rx="12" fill="rgba(0,0,0,.22)" stroke="rgba(255,255,255,.12)"/>
        <rect x="200" y="46" width="180" height="78" rx="12" fill="rgba(0,0,0,.18)" stroke="rgba(255,255,255,.10)"/>
        <rect x="40" y="136" width="340" height="48" rx="12" fill="rgba(0,0,0,.18)" stroke="rgba(255,255,255,.10)"/>
        <text x="54" y="92" fill="rgba(232,238,255,.85)" font-size="14" font-weight="800">pizarra</text>
        <text x="214" y="92" fill="rgba(232,238,255,.75)" font-size="14" font-weight="800">pared / ventanas</text>
        <text x="54" y="166" fill="rgba(232,238,255,.75)" font-size="14" font-weight="800">mesas (pero no las ves todas)</text>
        <circle cx="340" cy="160" r="18" fill="rgba(122,167,255,.25)" stroke="rgba(122,167,255,.55)"/>
        <text x="333" y="166" fill="rgba(232,238,255,.9)" font-size="14" font-weight="900">üë¶</text>
      </svg>
    `;
  }

  function svgPlanRoom(){
    return `
      <svg viewBox="0 0 420 220" width="100%" height="100%" role="img" aria-label="Plano del aula desde arriba">
        <rect x="18" y="18" width="384" height="184" rx="18" fill="rgba(0,0,0,.18)" stroke="rgba(255,255,255,.18)"/>
        <rect x="40" y="40" width="120" height="30" rx="10" fill="rgba(46,229,157,.18)" stroke="rgba(46,229,157,.55)"/>
        <text x="52" y="61" fill="rgba(232,238,255,.85)" font-size="13" font-weight="900">PIZARRA</text>
        <rect x="320" y="40" width="60" height="30" rx="10" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.16)"/>
        <text x="332" y="61" fill="rgba(232,238,255,.75)" font-size="13" font-weight="900">PUERTA</text>
        ${[0,1,2,3,4].map(i=>{
          const x = 70 + i*62;
          return `<rect x="${x}" y="110" width="44" height="44" rx="12" fill="rgba(122,167,255,.14)" stroke="rgba(122,167,255,.35)"/>`;
        }).join("")}
        <text x="40" y="98" fill="rgba(169,182,230,.95)" font-size="12" font-weight="800">MESAS (se ven todas)</text>
        <circle cx="220" cy="86" r="16" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)"/>
        <text x="213" y="92" fill="rgba(232,238,255,.9)" font-size="14" font-weight="900">üë¶</text>
      </svg>
    `;
  }

  function svgHallPhoto(){
    return `
      <svg viewBox="0 0 420 220" width="100%" height="100%" role="img" aria-label="Foto estilo pasillo">
        <rect x="12" y="12" width="396" height="196" rx="18" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)"/>
        <rect x="40" y="46" width="120" height="128" rx="14" fill="rgba(0,0,0,.20)" stroke="rgba(255,255,255,.12)"/>
        <rect x="190" y="46" width="190" height="128" rx="14" fill="rgba(0,0,0,.16)" stroke="rgba(255,255,255,.10)"/>
        <text x="60" y="118" fill="rgba(232,238,255,.75)" font-size="14" font-weight="800">puertas</text>
        <text x="214" y="118" fill="rgba(232,238,255,.75)" font-size="14" font-weight="800">pasillo largo</text>
        <circle cx="320" cy="170" r="18" fill="rgba(255,92,122,.18)" stroke="rgba(255,92,122,.50)"/>
        <text x="313" y="176" fill="rgba(232,238,255,.9)" font-size="14" font-weight="900">üöª</text>
      </svg>
    `;
  }

  function svgHallPlan(){
    return `
      <svg viewBox="0 0 420 220" width="100%" height="100%" role="img" aria-label="Plano del pasillo">
        <rect x="18" y="18" width="384" height="184" rx="18" fill="rgba(0,0,0,.18)" stroke="rgba(255,255,255,.18)"/>
        <rect x="60" y="92" width="300" height="38" rx="14" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)"/>
        ${[0,1,2,3].map(i=>{
          const x = 78 + i*66;
          return `<rect x="${x}" y="56" width="42" height="28" rx="10" fill="rgba(122,167,255,.12)" stroke="rgba(122,167,255,.30)"/>`;
        }).join("")}
        ${[0,1,2,3].map(i=>{
          const x = 78 + i*66;
          return `<rect x="${x}" y="138" width="42" height="28" rx="10" fill="rgba(122,167,255,.12)" stroke="rgba(122,167,255,.30)"/>`;
        }).join("")}
        <circle cx="340" cy="110" r="18" fill="rgba(46,229,157,.20)" stroke="rgba(46,229,157,.55)"/>
        <text x="333" y="116" fill="rgba(232,238,255,.9)" font-size="14" font-weight="900">üöª</text>
        <text x="60" y="40" fill="rgba(169,182,230,.95)" font-size="12" font-weight="800">VISTA DESDE ARRIBA</text>
        <path d="M80 111 H300" stroke="rgba(46,229,157,.75)" stroke-width="5" stroke-linecap="round"/>
        <polygon points="300,104 314,111 300,118" fill="rgba(46,229,157,.85)"/>
      </svg>
    `;
  }

  function svgSquashAnim(){
    return `
      <svg viewBox="0 0 840 200" width="100%" height="180" role="img" aria-label="De real a mapa">
        <defs>
          <linearGradient id="gg" x1="0" x2="1">
            <stop offset="0" stop-color="rgba(122,167,255,.18)"/>
            <stop offset="1" stop-color="rgba(255,255,255,.06)"/>
          </linearGradient>
        </defs>

        <rect x="16" y="24" width="240" height="152" rx="18" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.12)"/>
        <text x="30" y="52" fill="rgba(169,182,230,.95)" font-size="14" font-weight="900">REAL</text>
        <rect x="40" y="70" width="190" height="88" rx="14" fill="rgba(0,0,0,.18)" stroke="rgba(255,255,255,.10)"/>
        <text x="58" y="122" fill="rgba(232,238,255,.75)" font-size="14" font-weight="800">dentro</text>

        <path d="M280 100 C330 40, 390 40, 440 100 C390 160, 330 160, 280 100 Z" fill="url(#gg)" stroke="rgba(122,167,255,.25)"/>
        <text x="324" y="106" fill="rgba(232,238,255,.80)" font-size="14" font-weight="900">‚á© desde arriba</text>

        <rect x="494" y="24" width="330" height="152" rx="18" fill="rgba(0,0,0,.14)" stroke="rgba(255,255,255,.12)"/>
        <text x="510" y="52" fill="rgba(169,182,230,.95)" font-size="14" font-weight="900">MAPA</text>
        <rect x="520" y="70" width="140" height="28" rx="10" fill="rgba(46,229,157,.18)" stroke="rgba(46,229,157,.45)"/>
        <rect x="520" y="110" width="260" height="46" rx="14" fill="rgba(122,167,255,.12)" stroke="rgba(122,167,255,.28)"/>
        <text x="530" y="90" fill="rgba(232,238,255,.85)" font-size="12" font-weight="900">PIZARRA</text>
        <text x="530" y="139" fill="rgba(232,238,255,.75)" font-size="12" font-weight="900">se ve todo</text>
      </svg>
    `;
  }

  // ----------------------------
  // Start
  // ----------------------------
  render();

})();
</script>
</body>
</html>
